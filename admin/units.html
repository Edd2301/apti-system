<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Units Management - APTI Property Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../common/css/style.css">
</head>
<body class="admin-theme">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-content">
                <a href="dashboard.html" class="nav-brand">APTI Admin</a>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html">Dashboard</a></li>
                    <li class="nav-item"><a href="units.html" style="color: var(--primary-color);">Units</a></li>
                    <li class="nav-item"><a href="tenants.html">Tenants</a></li>
                    <li class="nav-item"><a href="bills.html">Bills</a></li>
                    <li class="nav-item"><a href="payment.html">Payments</a></li>
                    <li class="nav-item"><a href="maintenance.html">Maintenance</a></li>
                    <li class="nav-item"><a href="document_lease.html" class="active">Document Lease</a></li>
                    <li class="nav-item"><a href="sms_email.html" class="active">Communications</a></li>
                </ul>
                </ul>
                <div class="nav-user">
                    <span id="userGreeting">Welcome, Admin</span>
                    <button onclick="APTI_Auth.logout('admin')" class="btn btn-outline" style="margin-left: 1rem;">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" style="padding: 2rem 1rem;">
        <div class="flex-between mb-4">
            <div>
                <h1>Units Management</h1>
                <p>Manage property units and their details</p>
            </div>
            <button onclick="showAddUnitModal()" class="btn btn-primary">Add New Unit</button>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title">Filters</h3>
            </div>
            <div class="grid grid-4">
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="statusFilter" class="form-select" onchange="filterUnits()">
                        <option value="">All Statuses</option>
                        <option value="vacant">Vacant</option>
                        <option value="occupied">Occupied</option>
                        <option value="maintenance">Maintenance</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Unit Type</label>
                    <select id="typeFilter" class="form-select" onchange="filterUnits()">
                        <option value="">All Types</option>
                        <option value="1 Bedroom">1 Bedroom</option>
                        <option value="2 Bedroom">2 Bedroom</option>
                        <option value="3 Bedroom">3 Bedroom</option>
                        <option value="Studio">Studio</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Search</label>
                    <input type="text" id="searchInput" class="form-input" placeholder="Search by unit number..." oninput="filterUnits()">
                </div>
                <div class="form-group">
                    <label class="form-label">&nbsp;</label>
                    <button onclick="clearFilters()" class="btn btn-outline" style="width: 100%;">Clear Filters</button>
                </div>
            </div>
        </div>

        <!-- Units Table -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Units List</h3>
            </div>
            <div id="messageContainer"></div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Unit Number</th>
                            <th>Type</th>
                            <th>Rent</th>
                            <th>Status</th>
                            <th>Tenant</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="unitsTableBody">
                        <!-- Units will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Unit Modal -->
    <div id="unitModal" class="modal hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: var(--admin-card-bg); border-radius: 0.5rem; padding: 2rem; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div class="flex-between mb-3">
                <h2 id="modalTitle">Add New Unit</h2>
                <button onclick="closeUnitModal()" style="background: none; border: none; color: inherit; font-size: 1.5rem; cursor: pointer;">Ã—</button>
            </div>
            
            <div id="modalMessageContainer"></div>
            
            <form id="unitForm">
                <input type="hidden" id="unitId" name="unitId">
                
                <div class="form-group">
                    <label for="unitNumber" class="form-label">Unit Number *</label>
                    <input type="text" id="unitNumber" name="unitNumber" class="form-input" required placeholder="e.g., A101">
                </div>
                
                <div class="form-group">
                    <label for="unitType" class="form-label">Unit Type *</label>
                    <select id="unitType" name="type" class="form-select" required>
                        <option value="">Select Type</option>
                        <option value="Studio">Studio</option>
                        <option value="1 Bedroom">1 Bedroom</option>
                        <option value="2 Bedroom">2 Bedroom</option>
                        <option value="3 Bedroom">3 Bedroom</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="rent" class="form-label">Monthly Rent *</label>
                    <input type="number" id="rent" name="rent" class="form-input" required min="0" step="0.01" placeholder="1200.00">
                </div>
                
                <div class="form-group">
                    <label for="unitImages" class="form-label">Unit Images</label>
                    <input type="file" id="unitImages" name="images" class="form-input" multiple accept="image/*">
                    <div style="font-size: 0.75rem; color: var(--admin-text-secondary); margin-top: 0.25rem;">
                        Upload multiple images (max 5MB each)
                    </div>
                </div>
                
                <div class="flex" style="gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save Unit</button>
                    <button type="button" onclick="closeUnitModal()" class="btn btn-outline" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Chatbot -->
    <button class="chatbot-button" onclick="openChatbot()">ðŸ’¬</button>
    <div id="chatbotWindow" class="chatbot-window hidden">
        <div class="chatbot-header">
            <span>APTI Assistant</span>
            <button onclick="closeChatbot()" style="float: right; background: none; border: none; color: inherit; cursor: pointer;">Ã—</button>
        </div>
        <div class="chatbot-messages" id="chatbotMessages">
            <div style="padding: 0.5rem; background: rgba(79, 70, 229, 0.1); border-radius: 0.5rem; margin-bottom: 0.5rem;">
                This is the unit management message receiver. Messages from tenants will appear here.
            </div>
        </div>
        <div class="chatbot-input" style="display: none;">
            <input type="text" id="chatbotInput" placeholder="Type your message..." class="form-input" disabled>
            <button onclick="sendChatMessage()" class="btn btn-primary" disabled>Send</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="../common/js/firebase-config.js"></script>
    <script src="../common/js/util.js"></script>
    <script src="../common/js/auth.js"></script>
    <script src="../common/js/admin.js"></script>
    <script>
        let allUnits = [];
        let currentEditingUnit = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Check Firebase authentication state
            auth.onAuthStateChanged(function(user) {
                if (!user) {
                    // User is not authenticated, redirect to login
                    window.location.href = 'login.html';
                    return;
                }

                // User is authenticated, load page
                console.log('User authenticated:', user.email);

                // Load user info
                if (user.displayName) {
                    document.getElementById('userGreeting').textContent = `Welcome, ${user.displayName}`;
                } else if (user.email) {
                    document.getElementById('userGreeting').textContent = `Welcome, ${user.email.split('@')[0]}`;
                }

                // Load units
                loadUnits();

                // Setup form handler
                document.getElementById('unitForm').addEventListener('submit', handleUnitSubmit);
            });
        });

        async function loadUnits() {
            try {
                const result = await APTI_Admin.UnitsManager.getAll();
                
                if (result.success) {
                    allUnits = result.data;
                    displayUnits(allUnits);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error loading units:', error);
                APTI_Utils.showError(document.getElementById('messageContainer'), 'Failed to load units');
            }
        }

        function displayUnits(units) {
            const tbody = document.getElementById('unitsTableBody');
            
            if (units.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--admin-text-secondary);">
                            No units found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = units.map(unit => `
                <tr>
                    <td style="font-weight: 600;">${unit.unitNumber}</td>
                    <td>${unit.type}</td>
                    <td>${APTI_Utils.formatCurrency(unit.rent)}</td>
                    <td>
                        <span class="badge ${getStatusBadgeClass(unit.status)}">
                            ${APTI_Utils.capitalizeWords(unit.status)}
                        </span>
                    </td>
                    <td>${unit.tenantName || '-'}</td>
                    <td>
                        <button onclick="editUnit('${unit.id}')" class="btn btn-primary" style="margin-right: 0.5rem; padding: 0.25rem 0.75rem; font-size: 0.75rem;">
                            Edit
                        </button>
                        <button onclick="deleteUnit('${unit.id}')" class="btn btn-danger" style="padding: 0.25rem 0.75rem; font-size: 0.75rem;">
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusBadgeClass(status) {
            const statusMap = {
                'vacant': 'badge-warning',
                'occupied': 'badge-success',
                'maintenance': 'badge-danger'
            };
            return statusMap[status] || 'badge-info';
        }

        function filterUnits() {
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            let filteredUnits = allUnits.filter(unit => {
                const matchesStatus = !statusFilter || unit.status === statusFilter;
                const matchesType = !typeFilter || unit.type === typeFilter;
                const matchesSearch = !searchInput || 
                    unit.unitNumber.toLowerCase().includes(searchInput) ||
                    (unit.tenantName && unit.tenantName.toLowerCase().includes(searchInput));

                return matchesStatus && matchesType && matchesSearch;
            });

            displayUnits(filteredUnits);
        }

        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('searchInput').value = '';
            displayUnits(allUnits);
        }

        function showAddUnitModal() {
            currentEditingUnit = null;
            document.getElementById('modalTitle').textContent = 'Add New Unit';
            document.getElementById('unitForm').reset();
            document.getElementById('unitId').value = '';
            APTI_Utils.clearMessages(document.getElementById('modalMessageContainer'));
            document.getElementById('unitModal').classList.remove('hidden');
        }

        async function editUnit(unitId) {
            try {
                const result = await APTI_Admin.UnitsManager.getById(unitId);
                
                if (result.success) {
                    currentEditingUnit = result.data;
                    document.getElementById('modalTitle').textContent = 'Edit Unit';
                    document.getElementById('unitId').value = result.data.id;
                    document.getElementById('unitNumber').value = result.data.unitNumber;
                    document.getElementById('unitType').value = result.data.type;
                    document.getElementById('rent').value = result.data.rent;
                    
                    APTI_Utils.clearMessages(document.getElementById('modalMessageContainer'));
                    document.getElementById('unitModal').classList.remove('hidden');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error loading unit:', error);
                APTI_Utils.showError(document.getElementById('messageContainer'), 'Failed to load unit details');
            }
        }

        async function deleteUnit(unitId) {
            if (!confirm('Are you sure you want to delete this unit? This action cannot be undone.')) {
                return;
            }

            try {
                const result = await APTI_Admin.UnitsManager.delete(unitId);
                
                if (result.success) {
                    APTI_Utils.showSuccess(document.getElementById('messageContainer'), result.message);
                    await loadUnits();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error deleting unit:', error);
                APTI_Utils.showError(document.getElementById('messageContainer'), error.message);
            }
        }

        async function handleUnitSubmit(e) {
            e.preventDefault();
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            APTI_Utils.showLoading(submitButton, 'Saving...');
            
            try {
                const formData = new FormData(e.target);
                const unitData = {
                    unitNumber: formData.get('unitNumber'),
                    type: formData.get('type'),
                    rent: formData.get('rent')
                };

                // Handle file uploads
                const imageFiles = formData.getAll('images');
                if (imageFiles.length > 0 && imageFiles[0].size > 0) {
                    const uploadPromises = Array.from(imageFiles).map(file => 
                        APTI_Admin.handleFileUpload(file, 'image')
                    );
                    
                    const uploadResults = await Promise.all(uploadPromises);
                    const failedUploads = uploadResults.filter(result => !result.success);
                    
                    if (failedUploads.length > 0) {
                        throw new Error(`Image upload failed: ${failedUploads[0].error}`);
                    }
                    
                    unitData.images = uploadResults.map(result => result.data);
                }

                let result;
                if (currentEditingUnit) {
                    result = await APTI_Admin.UnitsManager.update(currentEditingUnit.id, unitData);
                } else {
                    result = await APTI_Admin.UnitsManager.create(unitData);
                }

                if (result.success) {
                    APTI_Utils.showSuccess(document.getElementById('modalMessageContainer'), result.message);
                    setTimeout(() => {
                        closeUnitModal();
                        loadUnits();
                    }, 1500);
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error('Error saving unit:', error);
                APTI_Utils.showError(document.getElementById('modalMessageContainer'), error.message);
            } finally {
                APTI_Utils.hideLoading(submitButton);
            }
        }

        function closeUnitModal() {
             const modals = document.getElementsByClassName('modal');
           currentLeaseDocument = null;
            for (let modal of modals) {
            modal.style.display = 'none';
    }
        }

        // Chatbot functionality
        function closeChatbot() {
            const chatbotWindow = document.getElementById('chatbotWindow');
            chatbotWindow.style.display = 'none';
            chatbotWindow.classList.add('hidden');
        }

        function openChatbot() {
            const chatbotWindow = document.getElementById('chatbotWindow');
            chatbotWindow.style.display = 'block';
            chatbotWindow.classList.remove('hidden');
            document.getElementById('chatbotInput').focus();
        }

        function sendChatMessage() {
            const input = document.getElementById('chatbotInput');
            const messagesContainer = document.getElementById('chatbotMessages');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            const userMessage = document.createElement('div');
            userMessage.style.cssText = 'padding: 0.5rem; background: var(--primary-color); color: white; border-radius: 0.5rem; margin-bottom: 0.5rem; margin-left: 2rem; text-align: right;';
            userMessage.textContent = message;
            messagesContainer.appendChild(userMessage);
            
            // Clear input
            input.value = '';
            
            // Simulate bot response
            setTimeout(() => {
                const botMessage = document.createElement('div');
                botMessage.style.cssText = 'padding: 0.5rem; background: rgba(79, 70, 229, 0.1); border-radius: 0.5rem; margin-bottom: 0.5rem;';
                
                // Unit-specific responses
                const responses = {
                    'add unit': 'To add a new unit, click the "Add New Unit" button and fill in the unit number, type, and rent amount.',
                    'edit unit': 'You can edit any unit by clicking the "Edit" button in the actions column of the units table.',
                    'delete unit': 'To delete a unit, click the "Delete" button. Note that occupied units cannot be deleted.',
                    'vacant units': `You currently have ${allUnits.filter(u => u.status === 'vacant').length} vacant units available for rent.`,
                    'occupied units': `You have ${allUnits.filter(u => u.status === 'occupied').length} occupied units generating rental income.`,
                    'rent': 'You can update rent amounts by editing the unit details. The system will track rent changes automatically.',
                    'default': 'I can help you with unit management tasks like adding new units, editing existing ones, or checking occupancy status. What would you like to know?'
                };
                
                const lowerMessage = message.toLowerCase();
                let response = responses.default;
                
                for (const key in responses) {
                    if (lowerMessage.includes(key)) {
                        response = responses[key];
                        break;
                    }
                }
                
                botMessage.textContent = response;
                messagesContainer.appendChild(botMessage);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 1000);
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Handle Enter key in chatbot input
        document.getElementById('chatbotInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // Close modal when clicking outside
        document.getElementById('unitModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeUnitModal();
            }
        });
    </script>
</body>
</html>