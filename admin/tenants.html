<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Tenants - APTI Property Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../common/css/style.css">
</head>
<body class="admin-theme">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-content">
                <a href="dashboard.html" class="nav-brand">APTI Admin</a>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html">Dashboard</a></li>
                    <li class="nav-item"><a href="units.html">Units</a></li>
                    <li class="nav-item"><a href="tenants.html" class="active">Tenants</a></li>
                    <li class="nav-item"><a href="bills.html">Bills</a></li>
                    <li class="nav-item"><a href="payment.html">Payments</a></li>
                    <li class="nav-item"><a href="maintenance.html">Maintenance</a></li>
                    <li class="nav-item"><a href="document_lease.html" class="active">Document Lease</a></li>
                    <li class="nav-item"><a href="sms_email.html" class="active">Communications</a></li>
                </ul>
                </ul>
                <div class="nav-user">
                    <span id="userGreeting">Welcome, Admin</span>
                    <button onclick="APTI_Auth.logout('admin')" class="btn btn-outline" style="margin-left: 1rem;">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" style="padding: 2rem 1rem;">
        <div class="flex-between mb-4">
            <div>
                <h1>Manage Tenants</h1>
                <p>View and manage all tenants in your property</p>
            </div>
            <button onclick="openAddTenantModal()" class="btn btn-primary">Add New Tenant</button>
        </div>

        <!-- Search and Filters -->
        <div class="card mb-4">
            <div class="grid grid-3">
                <div class="form-group">
                    <label class="form-label">Search Tenants</label>
                    <input type="text" id="searchInput" placeholder="Search by name, email, or unit..." class="form-input" oninput="searchTenants()">
                </div>
                <div class="form-group">
                    <label class="form-label">Status Filter</label>
                    <select id="statusFilter" class="form-select" onchange="filterTenants()">
                        <option value="">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Unit Filter</label>
                    <select id="unitFilter" class="form-select" onchange="filterTenants()">
                        <option value="">All Units</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tenants Table -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Tenants List</h3>
            </div>
            <div id="tenantsTableContainer">
                <div class="table-container">
                    <table class="table" id="tenantsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Contact</th>
                                <th>Email</th>
                                <th>Unit</th>
                                <th>Status</th>
                                <th>Lease Start</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tenantsTableBody">
                            <!-- Tenants will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="noTenantsMessage" class="hidden text-center p-4">
                    <p>No tenants found. <a href="#" onclick="openAddTenantModal()">Add your first tenant</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Tenant Modal -->
    <div id="tenantModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Tenant</h3>
                <button onclick="closeModal()" class="modal-close">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="tenantForm" onsubmit="handleTenantSubmit(event)">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label class="form-label">First Name *</label>
                            <input type="text" id="firstName" name="firstName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name *</label>
                            <input type="text" id="lastName" name="lastName" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email Address *</label>
                        <input type="email" id="email" name="email" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Phone Number *</label>
                        <input type="tel" id="phone" name="phone" class="form-input" required>
                    </div>
                    
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label class="form-label">Unit Assignment</label>
                            <select id="unitId" name="unitId" class="form-select">
                                <option value="">Select Unit</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select id="status" name="status" class="form-select">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Lease Start Date</label>
                        <input type="date" id="leaseStart" name="leaseStart" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Lease End Date</label>
                        <input type="date" id="leaseEnd" name="leaseEnd" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Emergency Contact</label>
                        <input type="text" id="emergencyContact" name="emergencyContact" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Emergency Phone</label>
                        <input type="tel" id="emergencyPhone" name="emergencyPhone" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea id="notes" name="notes" class="form-textarea" rows="3"></textarea>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" onclick="closeModal()" class="btn btn-outline">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Tenant</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <button onclick="closeDeleteModal()" class="modal-close">Ã—</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this tenant? This action cannot be undone.</p>
                <p><strong id="deleteTenantName"></strong></p>
            </div>
            <div class="modal-footer">
                <button onclick="closeDeleteModal()" class="btn btn-outline">Cancel</button>
                <button onclick="confirmDeleteTenant()" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <!-- Chatbot -->
    <button class="chatbot-button" onclick="openChatbot()">ðŸ’¬</button>
    <div id="chatbotWindow" class="chatbot-window hidden">
        <div class="chatbot-header">
            <span>APTI Assistant</span>
            <button onclick="closeChatbot()" style="float: right; background: none; border: none; color: inherit; cursor: pointer;">Ã—</button>
        </div>
        <div class="chatbot-messages" id="chatbotMessages">
            <div style="padding: 0.5rem; background: rgba(79, 70, 229, 0.1); border-radius: 0.5rem; margin-bottom: 0.5rem;">
                This is the tenant message receiver. Messages from tenants will appear here.
            </div>
        </div>
        <div class="chatbot-input" style="display: none;">
            <input type="text" id="chatbotInput" placeholder="Type your message..." class="form-input" disabled>
            <button onclick="sendChatMessage()" class="btn btn-primary" disabled>Send</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="../common/js/firebase-config.js"></script>
    <script src="../common/js/util.js"></script>
    <script src="../common/js/auth.js"></script>
    <script src="../common/js/admin.js"></script>
    <script>
        let currentEditingId = null;
        let currentDeletingId = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Check Firebase authentication state
            auth.onAuthStateChanged(function(user) {
                if (!user) {
                    // User is not authenticated, redirect to login
                    window.location.href = 'login.html';
                    return;
                }

                // User is authenticated, load page
                console.log('User authenticated:', user.email);

                // Load user info
                if (user.displayName) {
                    document.getElementById('userGreeting').textContent = `Welcome, ${user.displayName}`;
                } else if (user.email) {
                    document.getElementById('userGreeting').textContent = `Welcome, ${user.email.split('@')[0]}`;
                }

                // Initialize tenants page
                initTenantsPage();
            });
        });

        function initTenantsPage() {
            loadTenants();
            loadUnitOptions();
            initModals();
        }

        let allTenants = [];

        function loadTenants() {
            try {
                // For now, use mock data until TenantsManager is implemented
                const mockTenants = [
                    {
                        id: 'tenant1',
                        firstName: 'John',
                        lastName: 'Doe',
                        email: 'john.doe@example.com',
                        phone: '+1234567890',
                        unitId: 'unit1',
                        unitNumber: 'A101',
                        status: 'active',
                        leaseStart: '2024-01-01',
                        leaseEnd: '2024-12-31',
                        emergencyContact: 'Jane Doe',
                        emergencyPhone: '+1987654321',
                        notes: 'Responsible tenant, pays on time',
                        createdAt: new Date('2024-01-01'),
                        updatedAt: new Date('2024-01-01')
                    },
                    {
                        id: 'tenant2',
                        firstName: 'Alice',
                        lastName: 'Smith',
                        email: 'alice.smith@example.com',
                        phone: '+1555666777',
                        unitId: 'unit2',
                        unitNumber: 'A102',
                        status: 'pending',
                        leaseStart: '2024-02-01',
                        leaseEnd: '2025-01-31',
                        emergencyContact: 'Bob Smith',
                        emergencyPhone: '+1888999000',
                        notes: 'New tenant, move-in scheduled',
                        createdAt: new Date('2024-02-01'),
                        updatedAt: new Date('2024-02-01')
                    }
                ];
                
                allTenants = mockTenants;
                renderTenantsTable(allTenants);
                
            } catch (error) {
                console.error('Error loading tenants:', error);
                APTI_Utils.showError(document.getElementById('tenantsTableContainer'), 'Failed to load tenants');
            }
        }

        function renderTenantsTable(tenants) {
            const tableBody = document.getElementById('tenantsTableBody');
            const noTenantsMessage = document.getElementById('noTenantsMessage');
            
            if (!tenants || tenants.length === 0) {
                tableBody.innerHTML = '';
                noTenantsMessage.classList.remove('hidden');
                return;
            }
            
            noTenantsMessage.classList.add('hidden');
            
            tableBody.innerHTML = tenants.map(tenant => `
                <tr>
                    <td>${tenant.firstName} ${tenant.lastName}</td>
                    <td>${tenant.phone}</td>
                    <td>${tenant.email}</td>
                    <td>${tenant.unitNumber || 'Not assigned'}</td>
                    <td>
                        <span class="status-badge status-${tenant.status}">
                            ${tenant.status.charAt(0).toUpperCase() + tenant.status.slice(1)}
                        </span>
                    </td>
                    <td>${tenant.leaseStart ? new Date(tenant.leaseStart).toLocaleDateString() : 'N/A'}</td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="editTenant('${tenant.id}')" class="btn btn-sm btn-outline">Edit</button>
                            <button onclick="deleteTenant('${tenant.id}', '${tenant.firstName} ${tenant.lastName}')" class="btn btn-sm btn-danger">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function loadUnitOptions() {
            const unitSelect = document.getElementById('unitId');
            const unitFilter = document.getElementById('unitFilter');
            
            // For now, use mock units until UnitsManager is fully integrated
            const mockUnits = [
                { id: 'unit1', unitNumber: 'A101', status: 'occupied' },
                { id: 'unit2', unitNumber: 'A102', status: 'vacant' },
                { id: 'unit3', unitNumber: 'B201', status: 'maintenance' }
            ];
            
            // Clear existing options
            unitSelect.innerHTML = '<option value="">Select Unit</option>';
            unitFilter.innerHTML = '<option value="">All Units</option>';
            
            // Add unit options
            mockUnits.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.id;
                option.textContent = `${unit.unitNumber} (${unit.status})`;
                unitSelect.appendChild(option);
                
                const filterOption = document.createElement('option');
                filterOption.value = unit.id;
                filterOption.textContent = unit.unitNumber;
                unitFilter.appendChild(filterOption);
            });
        }

        function initModals() {
            const modal = document.getElementById('tenantModal');
            const deleteModal = document.getElementById('deleteModal');
            
            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeModal();
                }
                if (event.target === deleteModal) {
                    closeDeleteModal();
                }
            });
        }

        function openAddTenantModal() {
            const modal = document.getElementById('tenantModal');
            const modalTitle = document.getElementById('modalTitle');
            const form = document.getElementById('tenantForm');
            
            modalTitle.textContent = 'Add New Tenant';
            form.reset();
            currentEditingId = null;
            
            modal.classList.remove('hidden');
        }

        function openEditTenantModal(tenant) {
            const modal = document.getElementById('tenantModal');
            const modalTitle = document.getElementById('modalTitle');
            const form = document.getElementById('tenantForm');
            
            modalTitle.textContent = 'Edit Tenant';
            
            // Fill form with tenant data
            document.getElementById('firstName').value = tenant.firstName;
            document.getElementById('lastName').value = tenant.lastName;
            document.getElementById('email').value = tenant.email;
            document.getElementById('phone').value = tenant.phone;
            document.getElementById('unitId').value = tenant.unitId;
            document.getElementById('status').value = tenant.status;
            document.getElementById('leaseStart').value = tenant.leaseStart;
            document.getElementById('leaseEnd').value = tenant.leaseEnd;
            document.getElementById('emergencyContact').value = tenant.emergencyContact || '';
            document.getElementById('emergencyPhone').value = tenant.emergencyPhone || '';
            document.getElementById('notes').value = tenant.notes || '';
            
            currentEditingId = tenant.id;
            modal.classList.remove('hidden');
        }

        function closeModal() {
            const modal = document.getElementById('tenantModal');
            modal.classList.add('hidden');
        }

        function closeDeleteModal() {
            const modal = document.getElementById('deleteModal');
            modal.classList.add('hidden');
            currentDeletingId = null;
        }

        function handleTenantSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const tenantData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                unitId: formData.get('unitId'),
                status: formData.get('status'),
                leaseStart: formData.get('leaseStart'),
                leaseEnd: formData.get('leaseEnd'),
                emergencyContact: formData.get('emergencyContact'),
                emergencyPhone: formData.get('emergencyPhone'),
                notes: formData.get('notes')
            };
            
            // Basic validation
            if (!tenantData.firstName || !tenantData.lastName || !tenantData.email || !tenantData.phone) {
                APTI_Utils.showError(document.getElementById('tenantModal'), 'Please fill in all required fields');
                return;
            }
            
            if (currentEditingId) {
                // Update existing tenant
                updateTenant(currentEditingId, tenantData);
            } else {
                // Create new tenant
                createTenant(tenantData);
            }
        }

        function createTenant(tenantData) {
            try {
                // Generate mock ID and add to tenants array
                const newTenant = {
                    id: 'tenant' + (allTenants.length + 1),
                    ...tenantData,
                    unitNumber: getUnitNumber(tenantData.unitId),
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                allTenants.push(newTenant);
                renderTenantsTable(allTenants);
                closeModal();
                
                APTI_Utils.showSuccess(document.getElementById('tenantsTableContainer'), 'Tenant created successfully');
                
            } catch (error) {
                console.error('Error creating tenant:', error);
                APTI_Utils.showError(document.getElementById('tenantModal'), 'Failed to create tenant');
            }
        }

        function updateTenant(tenantId, tenantData) {
            try {
                const tenantIndex = allTenants.findIndex(t => t.id === tenantId);
                if (tenantIndex === -1) {
                    throw new Error('Tenant not found');
                }
                
                allTenants[tenantIndex] = {
                    ...allTenants[tenantIndex],
                    ...tenantData,
                    unitNumber: getUnitNumber(tenantData.unitId),
                    updatedAt: new Date()
                };
                
                renderTenantsTable(allTenants);
                closeModal();
                
                APTI_Utils.showSuccess(document.getElementById('tenantsTableContainer'), 'Tenant updated successfully');
                
            } catch (error) {
                console.error('Error updating tenant:', error);
                APTI_Utils.showError(document.getElementById('tenantModal'), 'Failed to update tenant');
            }
        }

        function editTenant(tenantId) {
            const tenant = allTenants.find(t => t.id === tenantId);
            if (tenant) {
                openEditTenantModal(tenant);
            }
        }

        function deleteTenant(tenantId, tenantName) {
            currentDeletingId = tenantId;
            document.getElementById('deleteTenantName').textContent = tenantName;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function confirmDeleteTenant() {
            if (!currentDeletingId) return;
            
            try {
                const tenantIndex = allTenants.findIndex(t => t.id === currentDeletingId);
                if (tenantIndex === -1) {
                    throw new Error('Tenant not found');
                }
                
                allTenants.splice(tenantIndex, 1);
                renderTenantsTable(allTenants);
                closeDeleteModal();
                
                APTI_Utils.showSuccess(document.getElementById('tenantsTableContainer'), 'Tenant deleted successfully');
                
            } catch (error) {
                console.error('Error deleting tenant:', error);
                APTI_Utils.showError(document.getElementById('deleteModal'), 'Failed to delete tenant');
            }
        }

        function searchTenants() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                renderTenantsTable(allTenants);
                return;
            }
            
            const filteredTenants = allTenants.filter(tenant =>
                tenant.firstName.toLowerCase().includes(searchTerm) ||
                tenant.lastName.toLowerCase().includes(searchTerm) ||
                tenant.email.toLowerCase().includes(searchTerm) ||
                (tenant.unitNumber && tenant.unitNumber.toLowerCase().includes(searchTerm)) ||
                tenant.phone.includes(searchTerm)
            );
            
            renderTenantsTable(filteredTenants);
        }

        function filterTenants() {
            const statusFilter = document.getElementById('statusFilter').value;
            const unitFilter = document.getElementById('unitFilter').value;
            
            let filteredTenants = allTenants;
            
            if (statusFilter) {
                filteredTenants = filteredTenants.filter(tenant => tenant.status === statusFilter);
            }
            
            if (unitFilter) {
                filteredTenants = filteredTenants.filter(tenant => tenant.unitId === unitFilter);
            }
            
            renderTenantsTable(filteredTenants);
        }

        function getUnitNumber(unitId) {
            const mockUnits = [
                { id: 'unit1', unitNumber: 'A101' },
                { id: 'unit2', unitNumber: 'A102' },
                { id: 'unit3', unitNumber: 'B201' }
            ];
            
            const unit = mockUnits.find(u => u.id === unitId);
            return unit ? unit.unitNumber : null;
        }

        function closeChatbot() {
            const chatbotWindow = document.getElementById('chatbotWindow');
            chatbotWindow.style.display = 'none';
            chatbotWindow.classList.add('hidden');
        }

        function openChatbot() {
            const chatbotWindow = document.getElementById('chatbotWindow');
            chatbotWindow.style.display = 'block';
            chatbotWindow.classList.remove('hidden');
            document.getElementById('chatbotInput').focus();
        }
    </script>
</body>
</html>
